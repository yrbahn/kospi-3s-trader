# 📈 3S-Trader: LLM 기반 코스피 포트폴리오 최적화 프레임워크

> **논문 기반 구현**: [3S-Trader: A Multi-LLM Framework for Adaptive Stock Scoring, Strategy, and Selection in Portfolio Optimization](https://arxiv.org/abs/2510.17393) (arXiv:2510.17393)

코스피 시가총액 Top 30 종목을 대상으로 LLM(대규모 언어 모델)을 활용한 자동 포트폴리오 구성 및 최적화 시스템입니다.

## 📖 프로젝트 개요

3S-Trader는 **학습 불필요(training-free)** 프레임워크로, 6개의 LLM 에이전트가 협력하여 주식 포트폴리오를 구성합니다:

- **뉴스, 기술적 지표, 재무제표**를 종합 분석
- **6차원 점수 체계**로 종목 간 객관적 비교
- **전략 반복 개선**으로 시장 변화에 적응
- **주간 리밸런싱**으로 포트폴리오 최적화

원 논문에서는 DJIA(다우존스) 종목에 적용하여 **131.83% 누적수익률**, **샤프비율 0.31**을 달성했습니다.

## 🏗️ 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                    3S-Trader Framework                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Stage 1: 시장 데이터 분석 (Market Analysis)                  │
│  ┌──────────┐ ┌──────────────┐ ┌──────────────┐            │
│  │ 뉴스     │ │ 기술적 지표   │ │ 재무제표     │             │
│  │ 에이전트  │ │ 에이전트     │ │ 에이전트      │            │
│  └────┬─────┘ └──────┬───────┘ └──────┬───────┘            │
│       │              │                │                     │
│       └──────────────┼────────────────┘                     │
│                      ▼                                      │
│  Stage 2: 종목 점수 평가 (Stock Scoring)                     │
│  ┌─────────────────────────────────┐                        │
│  │         점수 에이전트            │                        │
│  │  6차원: 재무건전성 | 성장잠재력   │                        │
│  │  뉴스감성 | 뉴스영향력           │                        │
│  │  가격모멘텀 | 변동성리스크        │                        │
│  └────────────────┬────────────────┘                        │
│                   ▼                                         │
│  Stage 3: 종목 선택 (Stock Selection)                        │
│  ┌─────────────────────────────────┐                        │
│  │       선택 에이전트              │ ◄── 현재 전략           │
│  │  최대 5종목 + 비중 배분          │                        │
│  └────────────────┬────────────────┘                        │
│                   ▼                                         │
│  Stage 4: 전략 반복 개선 (Strategy Iteration)                │
│  ┌─────────────────────────────────┐                        │
│  │       전략 에이전트              │ ◄── 과거 10주 이력      │
│  │  점수-수익률 관계 분석            │                        │
│  │  전략 업데이트                   │ ──► 다음 주 전략        │
│  └─────────────────────────────────┘                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 각 모듈 상세 설명

### 데이터 수집 (`src/data/`)

**🔗 MarketSense-AI 데이터베이스 통합** - 중복 수집 제거, 실시간 데이터 공유

| 모듈 | 설명 | 데이터 소스 |
|------|------|------------|
| `data_loader.py` | **MarketSense-AI PostgreSQL 연동** | marketsense-ai DB |
| ~~`price_collector.py`~~ | ~~주가 + 기술적 지표~~ | **DB에서 조회** |
| ~~`news_collector.py`~~ | ~~종목별 뉴스 수집~~ | **DB에서 조회** |
| ~~`fundamental_collector.py`~~ | ~~재무지표~~ | **DB에서 조회** |

**장점:**
- ✅ 중복 데이터 수집 제거
- ✅ marketsense-ai의 자동화된 데이터 파이프라인 활용
- ✅ 2,884 종목의 방대한 데이터 접근
- ✅ RAG, 증권사 리포트, 블로그 등 추가 데이터 활용 가능

### LLM 에이전트 (`src/agents/`)

| 에이전트 | 역할 | 입력 | 출력 |
|----------|------|------|------|
| `NewsAgent` | 뉴스 감성/영향 분석 | 최근 뉴스 목록 | 뉴스 분석 리포트 |
| `TechnicalAgent` | 기술적 추세 분석 | 가격+지표 데이터 | 기술적 분석 리포트 |
| `FundamentalAgent` | 재무 건전성 평가 | 재무제표 데이터 | 재무 분석 리포트 |
| `ScoreAgent` | 6차원 점수 부여 (1~10) | 3개 리포트 | JSON 점수 |
| `SelectorAgent` | 포트폴리오 구성 | 전체 점수 + 전략 | 종목/비중 JSON |
| `StrategyAgent` | 전략 반복 개선 | 점수-수익률 + 이력 | 새 전략 JSON |

### 6차원 점수 체계

| 차원 | 설명 | 높을수록 |
|------|------|---------|
| 🏦 재무건전성 | 기업 재무 안정성 | 펀더멘털 강하고 단기 리스크 낮음 |
| 🚀 성장잠재력 | 미래 확장 가능성 | 장기 수익 잠재력 큼 |
| 📰 뉴스감성 | 최근 뉴스 감성 극성 | 긍정적 뉴스 많음 |
| 💥 뉴스영향력 | 뉴스 범위/지속성 | 지속적이고 광범위한 영향 |
| 📊 가격모멘텀 | 최근 가격 추세 | 강하고 일관된 상승 |
| ⚡ 변동성리스크 | 가격 변동 수준 | 변동성 높고 불안정 |

### 포트폴리오 관리 (`src/portfolio/`)

| 모듈 | 설명 |
|------|------|
| `portfolio_manager.py` | 포트폴리오 구성, 자본 추적, 이력 관리 |
| `evaluator.py` | AR, SR, MDD, CR 계산 + 차트 생성 |

## 🔄 구현 시나리오: 주간 트레이딩 플로우

```
매주 월요일 장 시작 전:

1️⃣ [데이터 수집] (금요일 기준)
   ├─ pykrx로 최근 4주 주가 + 기술적 지표 수집
   ├─ 네이버 금융에서 최근 1주 뉴스 수집
   └─ pykrx로 재무지표 수집

2️⃣ [시장 분석] (3개 LLM 에이전트)
   ├─ 뉴스 에이전트: 각 종목 뉴스 분석 리포트 작성
   ├─ 기술적 에이전트: 가격 추세 + 지표 해석
   └─ 재무 에이전트: 재무 건전성 + 성장성 평가

3️⃣ [점수 평가] (점수 에이전트)
   └─ 3개 리포트 종합 → 6차원 점수 (1~10)

4️⃣ [포트폴리오 구성] (선택 에이전트)
   ├─ 현재 전략 + 전체 점수 → 최대 5종목 선택
   ├─ 비중 배분 (합계 ≤ 1, 나머지 현금)
   └─ 월요일 시가에 매수

5️⃣ [주간 보유]
   └─ 금요일 종가에 전량 매도

6️⃣ [전략 개선] (전략 에이전트)
   ├─ 이번 주 점수-수익률 관계 분석
   ├─ 최근 10주 전략 이력 참고
   └─ 다음 주 투자 전략 업데이트

→ 다음 주 1️⃣로 반복
```

## 🚀 설치 및 설정

### 1. 클론 및 의존성 설치

```bash
git clone https://github.com/yrbahn/kospi-3s-trader.git
cd kospi-3s-trader
pip install -r requirements.txt
```

### 2. OpenAI API 키 설정

```bash
cp .env.example .env
# .env 파일을 편집하여 API 키 입력
```

또는 환경변수로:
```bash
export OPENAI_API_KEY="sk-your-api-key"
```

### 3. 설정 확인

`config/config.yaml`에서 필요한 설정을 조정하세요:
- LLM 모델 (기본: gpt-4o)
- 백테스트 기간
- 초기 자본금
- 종목 유니버스

## 📊 사용법

### 백테스트 실행

```bash
# 기본 백테스트 (config.yaml의 기간)
python -m src.main

# 기간 지정
python -m src.main --start 2024-01-01 --end 2024-12-31

# 설정 파일 지정
python -m src.main --config my_config.yaml
```

### 결과 확인

실행 후 `results/` 디렉토리에 생성:
- `history_YYYYMMDD_HHMMSS.json` — 주간별 상세 이력
- `cumulative_returns.png` — 누적 수익률 차트
- `weekly_returns.png` — 주간 수익률 바 차트

### 테스트 실행

```bash
pytest tests/ -v
```

## ⚙️ 설정 파일 설명

### `config/config.yaml`

```yaml
llm:
  model: gpt-4o          # 사용할 LLM 모델
  temperature: 0.3        # 응답 다양성 (낮을수록 일관적)
  max_tokens: 4096        # 최대 토큰 수

trading:
  max_portfolio_stocks: 5          # 최대 보유 종목 수
  technical_lookback_weeks: 4      # 기술적 지표 룩백 기간
  strategy_history_length: 10      # 전략 이력 참조 길이

backtest:
  start_date: "2023-01-01"
  end_date: "2024-12-31"
  initial_capital: 100000000       # 초기 자본금 (1억원)
```

### `config/prompts.yaml`

모든 LLM 에이전트의 시스템/유저 프롬프트를 한국어로 관리합니다.
프롬프트를 수정하여 에이전트 동작을 커스터마이징할 수 있습니다.

## 📏 성능 지표 설명

| 지표 | 수식 | 설명 |
|------|------|------|
| **누적수익률 (AR)** | ∏(1+Rₜ) - 1 | 전체 기간 복리 수익률 |
| **샤프비율 (SR)** | E[Rₜ] / σ(Rₜ) | 위험 대비 수익 효율성 (높을수록 좋음) |
| **최대낙폭 (MDD)** | min(Cₜ - max Cᵢ) / max Cᵢ | 고점 대비 최대 하락폭 (작을수록 좋음) |
| **칼마비율 (CR)** | AR / \|MDD\| | 수익률 대비 최대 손실 비율 (높을수록 좋음) |

## 📁 프로젝트 구조

```
kospi-3s-trader/
├── README.md                          # 프로젝트 문서
├── requirements.txt                   # Python 의존성
├── .env.example                       # 환경변수 예시
├── .gitignore
├── config/
│   ├── config.yaml                    # 메인 설정
│   └── prompts.yaml                   # LLM 프롬프트 (한국어)
├── src/
│   ├── __init__.py
│   ├── main.py                        # 엔트리포인트
│   ├── data/
│   │   ├── price_collector.py         # 주가 + 기술적 지표 수집
│   │   ├── news_collector.py          # 네이버 금융 뉴스 수집
│   │   ├── fundamental_collector.py   # 재무제표 수집
│   │   └── data_manager.py            # 데이터 오케스트레이션
│   ├── agents/
│   │   ├── base_agent.py              # LLM 에이전트 기본 클래스
│   │   ├── news_agent.py              # 뉴스 분석
│   │   ├── technical_agent.py         # 기술적 분석
│   │   ├── fundamental_agent.py       # 재무 분석
│   │   ├── score_agent.py             # 6차원 점수 평가
│   │   ├── selector_agent.py          # 포트폴리오 선택
│   │   └── strategy_agent.py          # 전략 반복 개선
│   ├── portfolio/
│   │   ├── portfolio_manager.py       # 포트폴리오 관리
│   │   └── evaluator.py               # 성과 평가 + 차트
│   └── utils/
│       ├── logger.py                  # 로깅 설정
│       └── helpers.py                 # 유틸리티 함수
├── backtest/
│   └── backtester.py                  # 백테스팅 엔진
└── tests/
    └── test_basic.py                  # 기본 테스트
```

## 🎯 대상 종목 (코스피 시총 Top 30)

| # | 코드 | 종목명 | # | 코드 | 종목명 |
|---|------|--------|---|------|--------|
| 1 | 005930 | 삼성전자 | 16 | 034730 | SK |
| 2 | 000660 | SK하이닉스 | 17 | 032830 | 삼성생명 |
| 3 | 373220 | LG에너지솔루션 | 18 | 003550 | LG |
| 4 | 207940 | 삼성바이오로직스 | 19 | 066570 | LG전자 |
| 5 | 005380 | 현대차 | 20 | 012330 | 현대모비스 |
| 6 | 000270 | 기아 | 21 | 086790 | 하나금융지주 |
| 7 | 006400 | 삼성SDI | 22 | 015760 | 한국전력 |
| 8 | 051910 | LG화학 | 23 | 017670 | SK텔레콤 |
| 9 | 035420 | NAVER | 24 | 030200 | KT |
| 10 | 035720 | 카카오 | 25 | 009150 | 삼성전기 |
| 11 | 105560 | KB금융 | 26 | 018260 | 삼성에스디에스 |
| 12 | 055550 | 신한지주 | 27 | 316140 | 우리금융지주 |
| 13 | 096770 | SK이노베이션 | 28 | 033780 | KT&G |
| 14 | 003670 | 포스코홀딩스 | 29 | 010130 | 고려아연 |
| 15 | 028260 | 삼성물산 | 30 | 011170 | 롯데케미칼 |

## ⚠️ 주의사항

- 이 프로젝트는 **연구/교육 목적**으로 제작되었습니다.
- **실제 투자에 사용하여 발생하는 손실에 대해 책임지지 않습니다.**
- OpenAI API 사용 비용이 발생합니다 (30종목 × 4에이전트 × 주당 = 약 120+ API 호출/주).
- 백테스트 결과가 미래 성과를 보장하지 않습니다.

## 📄 라이선스

MIT License

## 🙏 참고 논문

```bibtex
@article{ahmad2025threesTrader,
  title={3S-Trader: A Multi-LLM Framework for Adaptive Stock Scoring, Strategy, and Selection in Portfolio Optimization},
  author={Ahmad, Hussain and others},
  journal={arXiv preprint arXiv:2510.17393},
  year={2025}
}
```
